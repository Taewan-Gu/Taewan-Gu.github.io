---
sidebar_position: 7
description: 파이썬 클린코드 챕터 7 요약
---

# Ch.07 제너레이터, 이터레이터 및 비동기 프로그래밍

## 제너레이터, 이터레이터

### Generator

메모리를 적게 사용하여 반복 객체를 생성하기 위해 고안된 Iterator 객체 반환 함수이다.

제너레이터 표현식을 이용하여 리스트를 사용하는 곳에 적은 메모리로 코드를 동작하게 해준다. sum 함수동작 방식을 보자. 밑의 예제를 보면 메모리를 줄이는 제너레이터 표현식 사용법을 알 수 있다.

```python
sum(x**2 for x in range(10)) # 이렇게 사용하기.
sum([x**2 for x in range(10)]) # 이렇게 사용하면 굳이 사용하지 않아도 될 메모리를 사용하게 된다.
```

### Iterable

반복할 수 있는 객체를 뜻한다. 시퀀스 객체나 맵 객체가 Iterable 객체이며, 각 요소를 순회할 수 있는 `__iter__()` 메소드를 가지고 있다. `__getItem__`, `__len__`을 통해 만들 수 있지만, 이는 `__iter__`를 사용하지 않았을 때 사용하는 대비책이므로 굳이 사용할 필요는 없어보인다.

### Iterator

Iterable 인스턴스에서 각 요소를 순회하기 위해 사용된다. Iterator는 연속된 항목을 반복하고, 각 항목의 위치를 기억하고 있다. 파이썬에서는 `__next__()` 메소드로 다음 항목을 가져올 수 있다.

<br/>

## 코루틴

코루틴은 제너레이터에서 `send()`가 덧붙여진거라고 봐도 무방할 듯하다. `send()` 함수를 통해 받아온 값을 `yield` 에 할당한 데이터로 가져오고 해당 값을 사용할 수 있도록 만들기 때문이다. 

밑의 예제처럼 된다고 하면 `next` 메서드를 통해 `yield` 까지 도달한 다음 `b.send()` 메서드를 실행하게 된다. 이래서 처음에 `next()`를 먼저 한 번 안해주게되면 `a` 에 값을 못 넣어주므로 에러가 뜨게 된다. 

```python
def ex():
    for i in range(100):
        a = yield i
        print(a)

b = ex()
next(b) # yield까지 도달
next(b) # 루프 돌고 다음 yield 도달
next(b) # 루프 돌고 다음 yield 도달
b.send(10) # 10을 a에 주입 후, 다음 yield로 도달

# 응답
None
None
10
```



### 고급 코루틴

제너레이터 안에 `return`을 포함할 수 있고 해당 `return`에 도달하면 `StopIteration`이라는 예외에 저장되어 최종 값을 반환할 수 있다.

```python
def gen():
    yield 1
    yield 2
    return 3

v = gen()
next(v)
next(v)
try:
    next(v)
except StopIteration as x:
    print("3 나오면 맞음. 나온 값: ", x.value)
```

또한, `yield from`을 사용하여 제너레이터 자체를 넘겨 작은 코루틴을 만들 수도 있다.



### 비동기 프로그래밍

코루틴을 사용하면서 비동기 프로그래밍을 한다. 위의 제너레이터를 활용한 코루틴을 보면 확실히 다른 코루틴을 일시정지하고 다른 코루틴을 실행시킬 수 있다고 생각할 수 있다. 이렇게 코루틴이 자원을 쓰고 반납하는 과정을 도와줄 친구가 있는데, 이 친구를 이벤트 루프라고 한다. 이 이벤트 루프는 스케줄링 메커니즘을 가지고 있고, 이 메커니즘에 따라 코루틴이 실행되고 일시정지되고 종료된다. 요즘은 이러한 예약어로써,  `async`, `await` 를 주로 사용한다.



비동기 프로그래밍에서 컨텍스트관리자와 반복관련 매직메서드들은 새로운 메서드로 사용되며,`__aenter__`, `__aexit__` 와 같이 원래 매직 메서드 앞에 `a`가 붙여진 채로 생성해야 한다.

<br/>

## 하면서 더 알게 된 점

제너레이터 표현식도 제너레이터 객체라는 것!

``` python
x**2 for x in range(10) # 왼쪽의 표현식도 제너레이터 객체에 포함된다.
range(10) # 이런 형식만 제너레이터 객체가 아니다.
```

<br/>
